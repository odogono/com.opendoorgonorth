# some parts taken from https://pedroteixeira.io/tuning-nginx-for-ghost/
# some parts take from https://gist.github.com/hwdsl2/d18a387d6436e319b85b

# user alex staff;
user nginx;
worker_processes 2;

daemon off;

events {
    worker_connections 1024;
}

http {
    server_names_hash_bucket_size 64;
    types_hash_max_size 2048;
    server_tokens off;
    include mime.types;
    default_type application/octet-stream;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options nosniff;
    # HTTP Strict Transport Security - force secure HTTPS connections
    # add_header Strict-Transport-Security max-age=15768000;
    # add_header X-Cache-Status $upstream_cache_status;

    sendfile on;
    gzip on;
    gzip_comp_level 6;
    gzip_disable "msie6";
    gzip_min_length 150;
    gzip_proxied any;
    gzip_types text/plain text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript application/json application/javascript;
    gzip_vary on;

    # Create a cache zone called "APP" stored on "/data/nginx/cache"
    proxy_cache_path /var/local/nginx/cache levels=1:2 keys_zone=APP:100m inactive=24h max_size=2g;
    proxy_temp_path /var/local/nginx/cache/tmp;
    proxy_cache_key "$scheme$host$request_uri";
    # In case of proxy errors (i.e. ghost is not running), use the cache
    proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;
    proxy_http_version 1.1;
    # Add header for debugging
    add_header X-Cache $upstream_cache_status;

    # If you don't always manage your blog via SSH port forwarding, set these to higher values:
    # client_body_buffer_size 128k;
    # client_max_body_size 20m;
    # Controlling buffer overflow attacks
    # http://www.cyberciti.biz/tips/linux-unix-bsd-nginx-webserver-security.html
    client_body_buffer_size  8k;
    client_header_buffer_size 1k;
    client_max_body_size 1m;
    large_client_header_buffers 4 8k;
    client_body_timeout   12;
    client_header_timeout 12;
    keepalive_timeout     15 15;
    send_timeout          10;
    map_hash_bucket_size 256;
    # This is for use with CloudFlare Flexible SSL, to identify the "real" scheme of requests
    map $http_x_forwarded_proto $real_scheme {
        default $scheme;
        https   https;
    }
    map $request_uri $loggable {
        default 1;
        "~^/rss/?$" 0;
        "/favicon.ico" 0;
        "/browserconfig.xml" 0;
        "/sitemap.xml" 0;
        "/robots.txt" 0;
    }
    # These settings provide more detailed Nginx logs. For example, "$real_scheme" is added
    # to the default log format. In addition, extra logs will be created in "access_logs".
    # Please be sure to create folder "/opt/nginx/logs/access_logs" with these permissions:
    # drwx------ 2 nginx root   4096 Apr  9 00:35 access_logs/
    log_format  main  '$remote_addr - $remote_user [$time_local] "$real_scheme" "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
    limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=1r/s;
    # In this block, put all IP addresses (or ranges) from which
    # you DO NOT want Nginx to log their visits in "access.log"
    geo $myips {
        default  0;
        127.0.0.0/8 1; # YOUR_IP_ADDRESS 1;
    }
    # Try to identify some robots by their IP (NOT complete!)
    geo $botips {
        default  0;
        # bingbot/msnbot:
        157.55.32.0/22 1; 157.55.36.0/24 1; 157.56.229.0/24 1; 157.56.92.0/24 1;
        157.56.93.0/24 1; 65.55.24.0/24  1; 65.55.52.0/24   1; 65.55.55.0/24  1;
        65.55.213.0/24 1; 65.55.215.0/24 1; 131.253.24.0/22 1; 199.30.16.0/20 1;
        157.55.39.0/24 1; 207.46.13.0/24 1; 40.77.167.0/24  1;
        # Baiduspider:
        123.125.71.0/24 1; 180.76.5.0/24 1; 180.76.6.0/24 1; 220.181.108.0/24 1;
        # Googlebot:
        209.85.238.0/24 1; 72.14.199.0/24 1; 66.249.64.0/19 1;
    }
    map $http_user_agent $isbot {
        default  0;
        "Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)" 1;
        "Mozilla/5.0 (iPhone; CPU iPhone OS 8_3 like Mac OS X) AppleWebKit/600.1.4 (KHTML, like Gecko) Version/8.0 Mobile/12F70 Safari/600.1.4 (compatible; Googlebot/2.1; +http://www.oogle.com/bot.html)" 1;
        "Mozilla/5.0 (Windows NT 6.1; rv:6.0) Gecko/20110814 Firefox/6.0 Google Favicon" 1;
        "Mozilla/5.0 (compatible; bingbot/2.0; +http://www.bing.com/bingbot.htm)" 1;
        "Mozilla/5.0 (compatible; Baiduspider/2.0; +http://www.baidu.com/search/spider.html)" 1;
        "Mozilla/5.0 (compatible; YandexBot/3.0; +http://yandex.com/bots)" 1;
        "Mozilla/5.0 (iPhone; CPU iPhone OS 8_1 like Mac OS X) AppleWebKit/600.1.4 (KHTML, like Gecko) Version/8.0 Mobile/12B411 Safari/600.1.4 (compatible; YandexMobileBot/3.0; +http://andex.com/bots)" 1;
        "Mozilla/5.0 (compatible; YandexImages/3.0; +http://yandex.com/bots)" 1;
        "Mozilla/5.0 (compatible; Exabot/3.0; +http://www.exabot.com/go/robot)" 1;
        "Mozilla/5.0 (compatible; linkdexbot/2.0; +http://www.linkdex.com/bots/)" 1;
        "Mozilla/5.0 (compatible; Yahoo! Slurp; http://help.yahoo.com/help/us/ysearch/slurp)" 1;
        "Mozilla/5.0 (compatible; archive.org_bot; Wayback Machine Live Record; +http://archive.org/details/archive.org_bot)" 1;
        "Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0); 360Spider(compatible; HaosouSpider; http://www.haosou.com/help/help_3_2.html)" 1;
        "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.89 Safari/537.1; 360Spider(compatible; HaosouSpider; http://www.haosou.com/help/help_3_2.tml)" 1;
        "Mozilla/5.0 (compatible; MojeekBot/0.6; +https://www.mojeek.com/bot.html)" 1;
        "Mozilla/5.0 (compatible; DotBot/1.1; http://www.opensiteexplorer.org/dotbot, help@moz.com)" 1;
        "Mozilla/5.0 (compatible; coccoc/1.0; +http://help.coccoc.com/)" 1;
        "Mozilla/5.0 (compatible; MJ12bot/v1.4.5; http://www.majestic12.co.uk/bot.php?+)" 1;
        "Mozilla/5.0 (compatible; AhrefsBot/5.0; +http://ahrefs.com/robot/)" 1;
        "Mozilla/5.0 (compatible; MegaIndex.ru/2.0; +http://megaindex.com/crawler)" 1;
        "Mozilla/5.0 (compatible; SeznamBot/3.2; +http://fulltext.sblog.cz/)" 1;
        "Mozilla/5.0 (compatible; Lipperhey-Kaus-Australis/5.0; +https://www.lipperhey.com/en/about/)" 1;
        "Mozilla/5.0 (compatible; BLEXBot/1.0; +http://webmeup-crawler.com/)" 1;
        "Mozilla/5.0 (compatible; spbot/4.4.2; +http://OpenLinkProfiler.org/bot )" 1;
        "Y!J-ASR/0.1 crawler (http://www.yahoo-help.jp/app/answers/detail/p/595/a_id/42716/)" 1;
        "Sogou web spider/4.0(+http://www.sogou.com/docs/help/webmasters.htm#07)" 1;
        "AddThis.com (http://support.addthis.com/)" 1;
        "~Tiny Tiny RSS/.* \(http://tt-rss\.org/\)" 1;
        "~Googlebot-Mobile/2\.1" 1;
    }
    map $http_referer $badref {
        default 0;
        "~*try\.php\?u=http" 1;
        "~*(semalt|rankings-analytics|(buttons|videos)-for|(best|success|100dollars|top1)-seo).*\.com" 1;
        "~*(baltkurs|(burger|pizza)-imperia|hundejo|hvd-store|pizza-tycoon|wrennmusic)\.com" 1;
        "~*(cyberspacers\.us|exchange\.cx|nanoyou\.org|justprofit\.xyz|(wordpress-crew|acuclubs)\.net)" 1;
    }
    map $http_user_agent $blocked_ua {
        default  0;
        "" 1;
        "~^$" 1;
        "Mozilla/4.0" 1;
        "~Mozilla/4\.0 \(compatible; MSIE (4\.0|5\.0|5\.5|6\.0)" 1;
        "~*(Indy Library|Squider|User-Agent|libwww-perl|morfeus|urllib|ZmEu|Nutch|masscan|libcurl|Wget)" 1;  # "
    }

    include /etc/nginx/conf.d/*.conf;
    # include conf.d/*.conf;
}